# Тестовые заглушки

Заглушки применяются когда в тестах вызывается функциональность, зависящая от глобальных настроек, или код, который довольно сложно протестировать (например, сетевые соединения).

Фикстура `monkeypatch` позволяет безопасно устанавливать или удалять атрубуты, элементы словарей, переменные окружения или модифицировать sys.path для импортирования.

Monkeypatch снабжает нас следующими инструментами для создания заглушек:

* `monkeypatch.setattr(obj, name, value, raising=True)`
* `monkeypatch.setattr("somemodule.obj.name", value, raising=True)`
* `monkeypatch.delattr(obj, name, rising=True)`
* `monkeypatch.setitem(mapping, name, value)`
* `monkeypatch.delitem(obj, name, rising=True)`
* `monkeypatch.setenv(name, value, prepend=None)`
* `monkeypatch.delenv(name, raising=True)`
* `monkeypatch.syspath_prepend(path)`
* `monkeypatch.chdir(path)`

Все изменения будут отменены после того, как тестовая функция или фикстура будут выполнены. Параметр raising устанавливает будут ли возбуждены исключения KeyError или AttributeError, когда целевого атрибута для установки/удаления не существует.

Заглушки применяются в следующих случаях:

* модификация поведения функции или свойства класса на время теста. Например, запрос в стороннее API или подключение к базе данных. В тесте мы не будем их делать, но хотим убедиться, что исходящие вызовы произошли. Чтобы запатчить функцию или свойство желаемым тестовым поведением используется `monkeypatch.setattr`. Чтобы удалить функцию или свойство на время теста используется `monkeypatch.delattr`.
* Изменение значений в словарях. Например, у нас есть глобальная конфигурация, которую мы хотим изменить на время теста. Для этого используется `monkeypatch.setitem`. Чтобы удалить значение из словаря используется `monkeypatch.delitem`.
* Модификация значений переменных окружения на время теста. Например, чтобы протестировать, как ведет себя программа, если переменная окружения не задана, или при различных значениях этой переменной. Для этого используются `monkeypatch.setenv` и `monkeypatch.delenv`
* Можно изменить переменную среды $PATH, используя конструкцию `monkeypatch.setenv("PATH", value, prepend=os.pathsep)`.
* Чтобы на время теста изменить текущую рабочую директорию используется конструкция `monkeypatch.chdir`.
* Чтобы модифицировать sys.path используется конструкция `monkeypatch.syspath_prepend`.

