# Выборка данных

Для получения данных из таблицы предназначен оператор `SELECT`. Он состоит из нескольких частей: выборки (в которой перечисляются столбцы, которые должны быть получены), списка таблиц (в нем перечисляются таблицы, из которых будут получены данные) и необязательного условия (определяющего ограничения).

Пример получения всех строк в таблице:

```sql
SELECT * FROM tablename;
```

`*` говорит, что нужно извлечь все столбцы. Часто в производственом стиле писать `*` считается плохим тоном, так как рзультат таких запросов будет меняться при добавлении новых столбцов.

Можно перечислить список столбцов, которые нужно получить

```sql
SELECT column1, column2, column3
FROM tablename;
```

В списке выборки можно писать не только списки на столбцы, но и выражения. Для явного задания приоритета выполнения операторов можно использовать скобки.

```sql
SELECT column1,
       (column2+column3)/2 AS alias,
       column3
FROM tablname;
```

SQL поддреживает математические операции:

* `+` сложение
* `-` вычитание
* `*` умножение
* `/` деление
* `^` степень
* `|/` квадратный корень
* множество других операторов и функций

Оператор `AS` позволяет задать имя исходному столбцу (слово AS можно опестить).

## where

Запрос можно дополнить условием, добавив предложение `WHERE`, ограничивающее множество возвращаемых строк. В предложении WHERE указывается логическое выражение.

* a = b
* a > b
* a >= b
* a < b
* a <= b
* a <> b или a != b

В результирующей выборке окажутся только те строки, для которых это выражение истинно.

### and, or, not

Логические выражения можно комбинировать, используя операторы and, or и not.

Запрос ниже вернет только те строки, в которых значение поля column3 положительное, а значение column2 отрицательное

```sql
SELECT * FROM tablename WHERE column3 > 0 AND column2 < 0;
```

### between

Иногда нужно получить, где значение какого-либо параметра находится в заданном диапазоне. Это можно сделать объединив логическим И два условия.

```sql
SELECT *
FROM orders
WHERE price >= 20 AND price <= 50;
```

Существует альтернативный вариант с использованием ключевого слова `BETWEEN`.

```sql
SELECT *
FROM orders
WHERE price BETWEEN 20 AND 40;
```

При использовании `BETWEEN` верхняя и нижняя границы диапазона включаются в поисковую выдачу. Если границы не должны быть включены, between применять нельзя.

### in, not in

```sql
SELECT *
FROM customers
WHERE country IN ('Germany', 'USA', 'UK', 'Holland');
```

Будут выбраны все клиенты, проживающие в странах, указанных в списке.

```sql
SELECT *
FROM customers
WHERE country NOT IN ('Germany', 'USA', 'UK');
```

Будут выбраны все клиенты, которые проживают в странах, отличных от указанных в списке.

### Like

Ключевое слово LIKE используется для поиска строк по шалону.

В шаблоне можно использовать служебные символы (placeholders):

* `%` - заполнитель означающий любое количество символов (в том числе 0)
* `_` - ровно 1 любой символ

Примеры:

* `LILE 'U%'` - строки, начинающиеся с U.
* `LIKE '%a'` - строки, оканчивающиеся на а.
* `LIKE '%John%'` - строки, содержащие John
* `LIKE 'J%n'` - строки, начинающиеся на J и кончающиеся на n
* `LIKE '_oh_'` - строки, где 2 и 3 символы oh, а первый и последний - любые
* `LIKE '_oh%'` - строки, где 2 и 3 символы - oh, первый - любой, в конце любое кодичество любых символов.

```sql
-- найти всех сотрудников, у которых имя оканчивается на -n
SELECT last_name, first_name
FROM employees
WHERE first_name LIKE '%n';
```

### Check on NULL

Ингода возникает задача отфильтровать строки по NULL. То есть найти строки, у которых какой-либо атрибут принимает значение NULL или наоборот не принимает значение NULL.

```sql
-- найти все заказы, которые еще не были отправлены
SELECT *
FROM orders
WHERE order_date IS NULL;

-- найти все отправленные заказы
SELECT *
FROM orders
WHERE order_date IS NOT NULL;
```

## Order by

Результат запроса можно отсортировать в нужном порядке с помощью предложения `ORDER BY`. Сортировать можно по одному или нескольким столбцам. Когда мы сортируем по нескольким столбцам, то сортировка по каждому следующему столбцу не будет нарушать сортировки по предыдущим столбцам.

Пример сортировки по одному столбцу.

```sql
SELECT * FROM tablename ORDER BY column1;
```

Пример сортировки по двум столбцам

```sql
SELECT * FROM tablename ORDER BY column1, column3;
```

Порядок сортировки задается ключевыми словами `ASC` (по возрастанию) и `DESC` (по убыванию). По умолчанию используется ASC.

```sql
SELECT DISTINCT country
FROM customers
ORDER BY country ASC;

SELECT DISTINCT country
FROM customers
ORDER BY country DESC;

SELECT DIXTINCT country, city
FROM customers
ORDER BY country ASC, city DESC
```

## Distinct

Можно убрать дублирующиеся строки из результата с помощью оператора `DISTINCT`.

```sql
SELECT DISTINCT column1 FROM tablename;
```

Выражние distinct может использоваться по нескольким колонкам. В этом случае будут выбраны записи, где уникальными являются комбинации выбранных значений.

```sql
SELECT DISTINCT column_1, column_2
FROM tablename;
```

## Limit

Limit ограничивает количество выводимых записей. Ключевое слово LIMIT ставится в запросе в самом конце.

```sql
-- вывести первые 10 имен сотрудников с вамилией Smith, отсортированных по дате их приема на работу.
SELECT first_name, last_name
FROM employees
WHERE last_name = 'Smith'
ORDER BY employment_date
LIMIT 10;
```

## Group by

Group by в запросе располагается между where и order by.

Пример: посчитать количество заказов, вес которых превышает 50 кг, отправляемых в каждую страну и отсортировать по колчеству.
```sql
SELECT ship_country, COUNT(*)
FROM orders
WHERE freight > 50
GROUP BY ship_country
ORDER BY COUNT(*) DESC;

-- посчитать сумму товаров в продаже по каждой категории
SELECT category_id, SUM(units_in_stock)
FROM products
GROUP BY category_id
ORDER BY SUM(units_in_stock) DESC
LIMIT 5;
```

### Having

HAVING, также как и WHERE, служит для фильтрации строк. Но where фильтрует строки до группировки, а having фильтрует после группировки. Соответственно, having имеет смысл использовать только вместе с group by.

```sql
-- вывести категории товаров, в которых продаж осуществляется больше чем на указанную сумму.
-- причем нас интересуют только те товары, которые будут впредь продаваться (discontinued <> 1)
SELECT category_id, SUM(unit_price * units_in_stock)
FROM products
WHERE discontinued <> 1
GROUP BY category_id
HAVING SUM(unit_price * units_in_stock) > 5000
ORDER BY SUM(unit_price * units_in_stock) DESC;
```

## Union

Union делает объединение результатов двух запросов.

Допустим, мы хотим вывести все страны, из которых наши заказчики и все страны, из которых наши сотрудники, чтобы это было в одной результирующей таблице. Сведения о заказчиках и сотрудниках хранятся в разных таблицах. Сначала мы получим страны из таблицы customer, потом получим страны из таблицы employees, а потом объединим результаты двух запросов с помощью оператора UNION.

```sql
SELECT country
FROM customers
UNION
SELECT country
FROM employees;
```

Если выполнит запрос выше, то результирующей таблице не будет дубликотов. Union убирает их из результирующей таблицы. Если мы хотим видеть результат как есть, со всеми дубликатами, то нужно использовать конструкцию `UNION ALL`.

```sql
SELECT country
FROM customers
UNION ALL
SELECT country
FROM employees;
```
