# Представления

Представление (view) - это сохраненный запрос в виде объекта БД (виртуальная таблица).

К представлениям можно делать запросы SELECT, их можно соединять и т.д. Производительность представлений такая же, как и у обычной таблицы (если сравнивать сопоставимые вещи).

Предположим, нас интересует запрос, который забирает информаицю из нескольких таблиц, но мы каждый раз не хотим вводить сложный запрос. По этому запросу можно создать представление и фактически присвоить имя запросу, а затем образаться к нему как к обычной таблице.

```sql
CREATE VIEW myview AS
    SELECT city, temp_lo, temp_hi, prcp, date, location
    FROM weather, cities
    WHERE city = name;

SELECT * FROM myview;

SELECT city, date, temp_lo
FROM myview
WHERE city = 'Moscow';
```

Для чего используются представления.

Активное использование представлений - ключевой момент хорошего проектирования баз данных SQL.

Представления позволяют скрыть внутреннее устройство таблиц, которые могут меняться по мере развития приложения, за надежными интерфейсами.

Представления можно использовать практически везде, где можно использовать обычные таблицы. Довольно часто представления создаются на базе других представлений.

Представления позволяют делать кеширование с помощью материализации. Смысл в том, что мы сохраняем результаты некоторого запроса, выполняемого клиентом часто.

Представление позволяет сокращать сложные запросы: мы можем часть сложного запроса сохранить в виде представления и делать запросы к нему. Таким образом мы можем сложный запрос разделить на несколько простых.

Позволяет подменить реальную таблицу.

Позволяет скрыть логику огрегации данных при работе через ORM.

Позволяет скрыть информацию (столбцы) от групп пользователей.

Позволяет скрыть информацию на уровне строк от групп пользователей (строки отсекаются самим запросом).

## Типы представлений

* Временные
* Рекурсивные
* Обновляемые
* Материализуемые

## Изменение представлений

Представления налагают некоторые ограничения на свое изменение

* Можно только добавлять новые столбцы
   * нельзя удалить существующие
   * нельзя поменять имена столбцов
   * нельзя поменять порядок следования столбцов

Синтаксис изменения представления:

```sql
CREATE OR REPLACE VIEW view_name AS
SELECT select_statement;
```

```sql
--создадим представление
CREATE VIEW cold_cities AS
SELECT *
FROM weather
JOIN cities
    ON weather.city = city.name;
WHERE weather.temp_hi < 10;

--изменим представление: поменяем условие в where
CREATE OR REPLACE VIEW cold_cities AS
SELECT *
FROM weather JOIN cities ON weather.city = city.name
WHERE weather.temp_hi < 15;
```

Если представление уже существует, то его содержание будет заменено на новый SELECT, но в этом селекте будут ограничения, описанные выше. Если нам нужны изменения, которых сделать нельзя, то представление придется удалить и создать заново.

Переименование представления

```sql
ALTER VIEW old_view_name RENAME TO new_view_name;
```

Удаление представления

```sql
DROP VIEW [IF EXISTS] view_name;
```

## Модификация данных через представления

Модифицировать данные через представленя можно, только если:

1. там используется одна таблица в секции FROM
2. не используется DISTINCT, GROUP BY, HAVING, UNION, INTERSECT, EXCEPT, LIMIT
3. нет оконных функций, MIN, MAX, SUM, COUNT, AVG

```sql
INSERT INTO view_name
VAUES (...);

Через представление можно удалять данные. Но мы не сможем через представление удалить данные, которых в нем нет (есть в таблице, но нет в представлении).

```sql
DELETE FROM view_name
WHERE conditions;
```
```
