# Индексы

Индексы позволяют повысить производительность базы данных. Индекс - специальная структура данных, которая связана с таблицей и создается на основе данных, содержащихся в ней.

Строки в таблицах хранятся в неупорядоченном виде. При выполнении операций выборки, обновления или удаления СУБД должна найти нужные строки. Для ускорения этого поиска и создается индекс.

Принцип индекса такой: на основе данных, содержащихся в конкретной строке таблицы, формируется значение элемента индекса, соответствующее этой строке. В каждый элемент индекса помещается указатель на строку, которой он соответствует. Индекс является упорядоченной структурой. Элементы в нем хранятся в отсортированном виде, что значительно ускоряет поиск данных в индексе. После отыскания в нем требуемой записи, СУБД переходит к соответствующей строке таблицы по прямой ссылке. Записи индекса могут формироваться на основе значений одного или нескольких полей соответствующих строк таблицы. Значения этих полей могут комбинироваться и преобразовываться различнфми способами. Все это определяет разработчик базы данных при создании индекса.

При выполнении поиска конкретных строк в талице специальная подсистема СУБД, называемая планировщиком, проверяет, имеется ли для таблицы индекс, осзданный на основе тех же столбцов, что указаны, например, в условии WHERE. Если такой индекс существует, то планировщик оценивает целесобразность его использования в данном конкретном случае. Если его использование целесообразно, то сначала выполняется поиск необходимых значений в индексе, а затем, если такие значения в нем найдены, производится обращение к таблице с использованием указателей, которые хранятся в записях индекса. Таким образом, полный перебор строк в таблице может быть заменен поиском в упорядоченном индексе и переходом к строке таблицы по прямому указателю (ссылке).

Использовать индексы нужно осмотрительно, так как индексы требуют накладных расходов на их создание и поддержание в актуальном состоянии при выполнении обновлений данных в таблицах.

Каждый индекс, созданный самой СУБД, имеет типовое имя, генерирующееся по следующему алгоритму:

* имя таблицы и суффикса pkey - для первичного ключа;
* имя таблицы, имена столбцов, по которым создан индекс, суффикс key - для уникального ключа.

В описании индекса присутствует список столбцов, по которым создан индекс, и тип индекса.

PostgreSQL может создавать индексы различных типов, но по умолчанию используется B-дерево.

Наличие индекса может ускорить выборку строк из таблицы, если он создан по столбцам, на основе значений которых происходит выборка. Поэтому, как правило, полезно создавать индексы с учетом наиболее часто выполняющихся выборок. Индекс, созданный по столбцу, участвующему в соединении двух таблиц, может позволить ускорить процесс выборки записей из таблиц. При выборке записей в отсортированном порядке индекс также может помочь, если сортировка выполняется по тем столбцам, по которым индекс создан.

Создавая индексы, нужно учитывать предполагаемую долю строк таблицы (селективность), выбираемых при выполнении типичных запросов, в которых индекс будет использоваться. Если эта доля велика (т.е. селективность низка), тогда наличие индекса может не дать ожидаемого эффекта. Индексы более полезны, когда из таблицы выбирается лишь небольшая доля строк, т.е. при высокой селективности выборки.

Если в SQL-запросе есть предложение ORDER BY, то индекс может позволить избежать этапа сортировки выбранных строк. Однако если SQL-запрос имеет маленькую селективность выборки, то явная сортировка выбранных строк может оказаться быстрее, чем использование индекса.

В случае использования ORDER BY в комбинации с LIMIT n явная сортировка (при отсутствии индекса) потребует обработки всех строк таблицы ради того, чтобы определить первые n строк. Но если есть индекс по тем же столбцам, по которым производится сортировка ORDER BY, то эти первые n строк могут быть извлечены непосредственно, без сканирования остальных строк вообще.

Создание индекса

```sql
CREATE INDEX index_name
   ON table_name (column_name, ...);
```

Имя индекса можно не указывать.

```sql
CREATE INDEX ON table_name (column_name, ...);
```

Когда индекс уже создан, о его поддержании в актуальном состоянии заботится СУБД. Это требует от СУБД затрат ресурсов и времени.

Удаление индекса

```sql
DROP INDEX index_name;
```

При создании индексов может использоваться не только возрастающий порядок значений в индексируемом столбце, но и убывающий. По умолчанию порядок возрастающий, при этом значения NULL, которые также могут присутствовать в индексируемых столбцах, идут последними. При создании индекса можно модифицировать поведение по умолчанию с помощью ключевых слов `ASC` (возрастающий порядок) и `DESC` (убывающий порядок), NULLS FIRST (эти значения идут первыми) и NULLS LAST (эти значения идут последнми)

```sql
CREATE INDEX index_name
    ON table_name (column_name NULLS FIRST, ...)

CREATE INDEX index_name
    ON table_name (column_name DESC NULLS LAST, ...)
```

## Индексы по нескольким столбцам

Индексы могут создаваться не только по одному столбцу, но и сразу по нескольким.

## Уникальные индексы

Индексы могут также использоваться для обеспечения уникальности значений атрибутов в строках таблицы. Для этого создается уникальный индекс.

```sql
CREATE UNIQUE INDEX index_name
    ON table_name (column_name, ...);
```

```sql
CREATE UNIQUE INDEX aircrafts_unique model_key
    ON aircrafts (model);
```

В этом случае, мы не сможем внести в таблицу aircrafts строки, имеющие одинаковые именования моделей самолетов. Когда мы при создании таблицы задаем ограничение уникальности для столбца, то уникальный индекс создается автоматически.

В уникальных индексах допускается значение NULL, поскольку они считаются не совпадающими ни с какими другими значениями, в том числе и друг с другом.

Если уникальный индекс создан по нескольким атрибутам, то совпадающими считаются те комбинации значений атрибутов в двух строках, в которых совпадают значения всех соответствующих атрибутов.
