# Функции

Функции - это объект в БД, принимающий аргументы и возвращающий результат.

## Зачем нужны функции?

* переиспользование функций различными клиентскими приложениями
* уменьшение трафика на сеть
* модульное программирование: что если нужна генерация случайных чисел от 1 до 10 в разных SQL-скриптах?
* ...

## Описание

* Функции состоят из набора утверждений, возвращая результат последнего
* могут содержать SELECT, INSERT, UPDATE, DELETE (CRUD)
* не могут содержать COMMIT, SAVEPOINT (TLC), VACUUM (utility). Однако функции сами по себе транзакционны: если при выполнении функции произошла какая-то ошибка, то все что было сделано внутри функции будет автоматически откачено

Функции делятся на:

* SQL-функции
* процедурные (PL/pgSQL - основной диалект)
* серверные функции (написанные на C)
* собственные С-функции

## Синтаксис

```sql
CREATE [OR REPLACE] FUNCTION func_name([arg1, arg2, ...]) RETURNS data_type AS $$
  --logic
$$ LANGUAGE lang
```

CREATE OR REPLACE, модифицирует уже существующую функцию с таким же наименованием

Аргументов может и не быть.

data_type - указание типа результата, который возвращает функция

lang - указание языка: SQL или PL/pgSQL

### Примеры

__Пример 1__: простейшая функция, которая не принимает никаких аргументов и ничего не возвращает.

Предположим, мы хотим проиндексировать зарплату тем сотрудникам, кто получает меньше 100000, и увеличить ее на 5%. Для этого нам понадобаиться выполнить такой запрос

```sql
UPDATE employees
SET salary = salary * 1.05
WHERE salary < 100000;
```

Данный запрос можно оформить в виде функции, чтобы со стороны клиентского приложения не нужно было писать SQL-запрос, а просто произвести вызов функции.

```sql
CREATE OR REPLACE FUNCTION index_salary() RETURNS void AS $$
  UPDATE employees
  SET salary = salary * 1.05
  WHERE region IS NULL;
$$ LANGUAGE SQL;
```

Данная функция не принимает никаких аргументов. Она личего не возвращает, поэтому мы пишем RETURNS void

Вызов созданной функции:

```sql
SELECT index_salary();
```

__Пример 2__: скалярная функция - функция, которая возвращает какое-то единственное значение.

Создадим функцию, которая возвращает суммарное количество всех товаров.

```sql
CREATE FUNCTION get_total_number_of_goods() RETURNS bigint AS $$
  SELECT SUM(units_in_stock)
  FROM products
$$ LANGUAGE SQL;

--вызов функции
SELECT get_total_number_of_goods() as total_goods;
```
