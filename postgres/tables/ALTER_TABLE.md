# Изменение таблиц

PostgreSQL предоставляет набор команд для модификации таблиц.

Вы можете:

* Добавлять столбцы
* Удалять столбцы
* Добавлять ограничения
* Удалять ограничения
* Изменять значения по умолчанию
* Изменять типы столбцов
* Переименовывать столбцы
* Переименовывать таблицы

Все эти действия выполняются с помощью команды `ALTER TABLE`.

## Добавление столбца

```sql
ALTER TABLE products ADD COLUMN description text;
```

Новый столбец заполнится заданными для него значениями по умолчанию (или значением NULL, если не добавить указание DEFAULT).

Начиная с PostgreSQL 11, добавление столбца с постоянным значением по умолчанию более не означает, что при выполнении команды ALTER TABLE будут изменены все строки таблицы. Вместо этого, установленное значение по умолчанию будет просто выдаваться при следующем обращении к строкам, а сохранятся в строках при перезаписи таблицы. Благодаря этому, опрация ALTER TABLE и с большими таблицами выполняется очень быстро.

Однако, если значение по умолчанию изменчивое (например, clock_timestamp()), в каждую строку нужно будет внести значение, вычисленное в момент выполнения ALTER TABLE. Чтобы избежать потенциально длительной операции изменения всех строк, если вы планируете заполнить столбец в основном не значениями по умолчанию, лучше будет добавить столбец без значения по умолчанию, затем вставить требуемые значения с помощью UPDATE, а потом определить значения по умолчанию.

Можно сразу определить ограничения столбца:

```sql
ALTER TABLE products ADD COLUMN description text CHECK (description <> '');
```

Здесь можно использовать все конструкции, допустимые в определении столбца в команде CREATE TABLE. Следует помнить, что значение по умолчанию должно удовлетворять данным ограничениям, чтобы операция ADD выполнилась успешно. Вы можете сначала заполнить столбец правильно, а затем добавить ограничения.

## Удаление столбца

```sql
ALTER TABLE products DROP COLUMN description;
```

Данные, которые были в этом столбце, исчезают. Вместе со столбцом удаляются и включающие его ограничения таблицы. Однако, если на столбец ссылается ограничение внешнего ключа другой таблицы, PostgreSQL не удалит это ограничеие неявно. Разрешить удаление всех зависящих от этого столбца объектов можно, добавив указание `CASCADE`:

```sql
ALTER TABLE products DROP COLUMN description CASCADE;
```

## Добавление ограничения

Для добавления ограничения используется синтаксис ограничения таблицы.

```sql
ALTER TABLE products ADD CHECK (name <> '');

-- Добавление стоблцу значения по умолчанию
ALTER TABLE products
ALTER COLUMN price SET DEFAULT 100;

ALTER TABLE products ADD CONSTRAINT some_name UNIQUE (product_no);

ALTER TABLE products ADD FOREIGN KEY (product_group_id)
    REFERENCES product_groups;

ALTER TABLE products
ADD CONSTRAINT FK_group_id FOREIGN KEY (product_group_id)
                           REFERENCES product_groups (group_id);

ALTER TABLE products ADD PRIMARY KEY (products_id);
```

Чтобы добавить ограничение NOT NULL, которое нельзя записать в виде ограничения таблицы, используется синтаксис:

```sql
ALTER TABLE products ALTER COLUMN product_no SET NOT NULL;
```

Ограничение проходит проверку автоматически и будет добавлено, только если ему удовлетворяют данные таблицы.

## Удаление ограничения

Для удаления ограничения необходимо знать его имя. Чтобы узнать имя ограничения можно в клиенте psql воспользоваться командой \d table_name или выполнить запрос

```sql
SELECT constraint_name
FROM information_schema.key_column_usage
WHERE table_name = 'students' AND
      table_schema = 'public';
```

Зная имя ограничения, нужно поспользоваться командой.

```sql
ALTER TABLE products DROP CONSTRAINT constraint_name;
```

Если имя ограничения имеет вид $2, нужно заключить его в кавычки, чтобы это был допустимый идентификатор.

Как и при удалении столбца, если необходимо удалить ограничение с зависимыми объектами, нужно добавить указание CASCADE.

Так можно удалить ограничения любых типов, кроме NOT NULL.

Чтобы удалить ограничение NOT NULL, нужно использовать команду

```sql
ALTER TABLE products ALTER COLUMN product_no DROP NOT NULL;
```

## Изменение значения по умолчанию

Назначить столбцу новое значение по умолчанию можно так:

```sql
ALTER TABLE products ALTER COLUMN price SET DEFAULT 7.77;
```

Эта команда никак не повлияет на суествующие строки таблицы, а просто задает новое значение по умолчанию для последующих команд INSERT.

Чтобы удалить значение по умолчанию нужно выполнить:

```sql
ALTER TABLE products ALTER COLUMN price DROP DEFAULT;
```

При этом, по сути значению по умолчанию просто присваивается NULL. Следовательно, не будет ошибки, исли попытаться удалить значение по умолчанию, не определенное явно, так как неявно оно существует и равняется NULL.

## Изменение типа столбца

```sql
ALTER TABLE table_name ALTER COLUMN column_name SET DATA TYPE data_type;
```

## Переименование столбца

```sql
ALTER TABLE table_name RENAME old_column_name TO new_column_name;
```

## Переименование таблицы

```sql
ALTER TABLE table_name RENAME TO new_table_name;
```
