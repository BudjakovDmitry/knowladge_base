# Проектирование баз данных

Базы данных проектируются опираясь на предметную область. Предметная область называется __доменом__. Предметной областью может быть все что угодно, например, если мы проектируем БД для нужд какой-то организации, то предметной областью будет эта организация с ее процессами. Таким образом база данных является моделью, которая отражает смысл некоторой предметной области с точки зрения данных, которыми оперируют в этой предметной области.

Процесс проектирования заключается в том, что нам нужно реальную предметную область смоделировать каким-то образом.

С точки зрения программиста наиболее важно _логическое проектирование_: между объектами в предметной области есть логические взаимосвязи и при проектировании эти взаимосвязи необходимо отразить. Также нужно отразить свойства и ограничения объектов прдметной области и т.д.

Потенциальные проблемы плохого проектирвоания:
* возможность записи не валидных данных
* возможность потери информации (нет нужных связей)
* отсутствие необходимой информации (забыли то, что нужно было)

## Стадии проектирования БД

* Анализ требований предметной области
* Логическое моделирование данных предметной области
* Физическое проектирование и нормализация

### Анализ требований

* Составление USE CASES (сценарии использование).

   Для этого нужно понять, кто действующие лица в предметной области, чтобы понмать, что они делают и чего они хотят от системы. Другими словами, какие субъекты есть и с какими объектами они взаимодействуют.

* Аналитический процесс с участием stakeholders (владельцев бизнеса и экспертов домена).

   Разработчики встречаются с экспертами домена и начинают разбирать сценарии использования.

* Построение концептуальной схемы БД

   Концептуальная схема представляет собой выделенные сущности и взаимосвязи между ними.

### Логическое проектирование

Логическое проектирование продолжает стадию анализа требований. Логическое проектирование детализирует концептуальную модель базы данных.

В результате логического проектирование необходимо:

* определить все ключи во всех таблицах
* определить все типы данных
* описать все логические ограничения (на практике, все логические ограничения на этапе проектирования выделить невозможно; они будут появлятся в процессе эксплуатации)
* нормализация отношений между таблицами обычно до формы 3НФ

### Физическая модель данных

* Выбирается конкретная СУБД
* Определяются типы данных (под конкретную СУБД)
* Определяются индексы
* Могут определяться представления
* Определяются ограничения на доступ
* Определяются стилистические ньюансыы именования объектов

По результатам проектирования строятся __ER-диаграммы__ (ER - Entity Relationship).

Для рисования ER-диагрумм существует множество инструментов

* MySQL Workbench
* Oracle SQL Developer Data Modeler
* pgModeler
* SQL Power Architect

## Плохие практики проектирования

* Полное игнорирование нормализации. Ведет к избыточности данных.
* Отсутствие стандартов именования на проекте.
* Одна таблица для разных по смыслу данных. Должно быть так: каждая таблица должна отражать некий объект.

## Нормальная форма

Нормальная форма (НФ) - свойство отношения, характеризующее его с точки зрения избыточности данных

Нормализация - процесс минимизации избыточности данных в отношении. Нормализация позволяет устранить дублирующиеся данные в таблице.

### 1НФ

У 1НФ к отношению есть три требования:

1. В отношении не должно содержаться строк дубликатов.
2. Все атрибуты должны быть простых типов данных.
3. Все значения скалярные (не составные).

Рассмотрим таблицу

author_name | books
--- | ---
Лев Толстой | Война и мир, Анна Каренина, Старик в церкви
Федор Достоевский | Игрок, Идиот, Бесы

Требование 1 выполняется. Требования 2 и 3 не выплняются, так как в одном поле содержатся по сти три значения.

Приведем к 1 НФ

author_name | book_title
--- | ---
Лев Толстой | Война и мир
Лев Толстой | Анна Каренина
Лев Толстой | Старик в церкви
Федор Достоевский | Игрок
Федор Достоевский | Идиот
Федор Достоевский | Бесы

## 2НФ

Требования:

* Удовлетворяет требованиям 1НФ
* Есть первичный ключ
* Все атрибты (поля) описывают первичный ключ целиком, а не лишь его часть

В результате получаем 3 таблицы:

author_id | author
--- | ---
1 | Лев Толстой
2 | Федор достоевский

В таблицу book добавились данные об издательстве

book_id | book_title | publisher_title | publisher_contact
--- | --- | --- | ---
1 | Война и мир | Альпина | 9031112233
2 | Анна Каренина | ЦентрИздат | 9032223344
3 | Старик в ццеркви | Питер | 9033334455
4 | Игрок | ЦентрИздат | 9032223344
5 | Идиот | ЦентрИздат | 9032223344
6 | Бесы | Альпина | 9031112233

author_id | book_id
--- | ---
1 | 1
1 | 2
1 | 3
2 | 4
2 | 5
2 | 6

## 3НФ

* Удовлетвоярет требованиям 2НФ
* Не должно быть зависимости одних неключевых атрибутов от других (все атрибуты должны зависеть только от первичного ключа) 

   В таблице book поле publisher_contact зависит от поля publisher_title. Оба поля не являются ключевыми. Это требование нарушается. Чтобы удовлетворить это требование нужно создать еще одну таблицу publisher, а в таблице book завести поле publisher_id, которое будет внешним ключем на таблицу publisher. 

publisher_id | publisher | contact
--- | --- | ---
1 | Альпина | 9031112233
2 | ЦентрИздат | 9032223344
3 | Питер | 9033334455

book_id | book_title | publisher_id
--- | --- | ---
1 | Война и мир | 1
2 | Анна Каренина | 2
3 | Старик в церкви | 3
4 | Икрок | 2
5 | Идиот | 2
6 | Бесы | 1

## Денормализация

Денормализация позволяет избежать лишних джойнов. В результате чего выборки могут проходить более быстро. Чаще всего, понять, нужна ли нам денормализация, можно только на практике.
