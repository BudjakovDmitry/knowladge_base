# Сравнение Nginx и Apache

## Принципы обработки http-соединений

По данным сервиса [w3techs.com](https://w3techs.com) Nginx является самым популярным веб-сервером в мире. Он используется на 34% вебсайтов. Второе место занимает Apache: 31.5% (данные на август 2021 г.).

Nginx гораздо более востребован в высоконагруженных проектах, где предполагается большое количество одновременных соединений. Чтобы понять, почему так происходит, нужно разабраться в том, как Apache и Nginx обработывают http-соединения. Именно в том, как эти два сервера обрабатывают http-соединения, кроется глобальная разница между ними.

У Apache есть три модуля мультипроцессонсти, которые администратор выбирает в процессе настройки сервера:

* mpm_prefork
* mpm_worker
* mpm_event

В режиме mpm_prefork сервер на каждое соединение создает один процесс, внутри которого есть один поток. В результате на каждое соединение выделяется отдельный процесс. Как извстно, на обслуживание процесса операционная система тратит достаточно много оперативной памяти и процессного времени. Если на сайт одновременно заходят несколько человек, то эта схема работает нормально. Однако, если на сайт прийдет большое количество пользователей, то довольно быстро кончится оперативная память и процессорные ресурсы. Следовательно highload-проекты по такой схеме работать не могут.

В режиме mpm_worker внутри процесса создается несколько потоков. Каждый поток обслуживает только одно http-соединение. Это немного более эффективно, но тоже достаточно затратно.

В модуле mpm_event оптимизирована работа с соединениями типа keep-alive. Keep-alive соединение, это когда соединение сохраняется после завершения http-запроса. Например, когда мы загружаем web-страницу, то сначала загружается html-документ, потом загружаются скрипты, потом стили, картинки и т.п, и при этом на каждый запрос не устанавливается новое http-соединение. Все запросы идут в рамках одного соединения. Тем не менее, в этой схеме по-прежнему каждое соединение обслуживает отдельный поток, что не очень эффективно.

Схема работы Nginx принципиально отличается. Nginx имеет один родительский процесс, который загружает конфигурацию и запускает дочерние процессы: воркеры. Каждый воркер работает по модели event-loop, тем самым может одновременно обрабатывать очень большое количество http-соединений. Воркер в цикле обходит большое количество http-соединений и обрабатывает события, происходящие в этих соединениях. Например, пришло новое http-соединение, воркер отвечает ему, тем самым устанавливая соединение, и идет дальше, обрабатывать следующие соединения. Когда он снова возвращается в этому соединению, то понимает, что нужно запросить какие-то данные из файловой системы. Воркер запрашивает эти данные и идет обрабатывать следующие соединения. Когда данные из файловой системы прийдут, он отдаст их http-соединению. Таким образом, каждый воркер может обрабатывать одновременно очень большое количество http-соединений, что делает Nginx очень эффективным по использованию оперативной памяти, процессорного времени и т.п. При увеличении нагрузки расход оперативной памяти и процессорных реурсов очень хорошо предсказуем, что нельзя сказать об Apache.

## Работа со статичским и динамическим контентом

Разберемся, как работают Apache и Nginx с динамическим и статическим контентом. Статический контент - это обыкновенные файлы, например, изображения. Динамический контент - это какие-то скрипты, наприер PHP или Python.

Если говорить про Apache и PHP, то внутри Apache есть модуль PHP: mod_php. Этот модуль работает внутри самого веб-сервера: каждый воркер (проесс) содержит в себе загруженный модуль mod_php. Из-за этого не получится работать например, с разными версиями языка PHP.

Nginx не может обрабатывать внутри себя какие-либо языки программирования, но он умеет отлично перенаправлять (проксировать) запросы. Классическая схема работы Nginx и PHP: Nginx принимает запрос к PHP скрипту и сразу же проксирует этот запрос дальше к серверу приложения. На этом сервере уже могут быть Apache с mod_php или php_fpm или что-то другое. Т.е. Nginx просто проксирует через себя динамические запросы, которые обрабатывает кто-то другой, возвращает результат Nginx, а тот в свою очередь проксирует результат http-соединению. Таким образом, Nginx не обращается напрямую к интерпретатору PHP или Python, он работает как прокси-сервер, проксируя запросы к серверу приложения (например, gunicorn для Python или php_fpm для PHP).

Статический контент Nginx обрабатывает гораздо быстрее, потому что не держит в памяти много лишнего, например mod_php. Он получает запрос на статику, тут же отдает ее и идет обрабатывать остальные щапросы. Apache на отдачу статики тратит гораздо больше ресурсов, чем Nginx.

## Конфигурирование

В Apache есть файлы конфигурации .htaccess. В разных директориях веб-сервера могут располагаться разные файлы htaccess, которые позволяют настроить веб-сервер. В Nginx вся конфигурация хранится централизованно и она завязана не на директории веб-сервера, а на url запроса: домен, поддомен и путь внутри запроса. Это связано с тем, что Nginx проектировался как прокси-сервер. Подобный подход позволяет настроить сервер так, что mysite.ru/1 будет проксироваться на PHP интерпретатор, а mysite.ru/2 будет проксироваться на Python интерпретатор.

То, что в Nginx нет htaccess файлов, с одной стороны, это менее удобно, так как нельзя конфигурировать что-то на уровне директории сервера, но с другой стороны это гораздо более безопасно, так как вся конфигурация централизована и ее настраивает администратор сервера. Также это более эффективно с точки зрения потребления ресурсов, потому что Apache в процессе выполнения каждого http-запроса ищет htaccess файл, читает его и парсит. Это все занимает время и ресурсы. В Nginx файл конфигурации загружается один раз и при каждом http-запросе никакие конфигурационные файлы не ищутся.

## Итог

Nginx быстрее обрабатывает http-запросы, он гораздо быстрее работает со статикой, он позволяет хранить конфиги централизовано и запускеть разные версии языков программирования в рамках одного сервера, и позволяет очень эффективно проксировать запросы. Главное преимущество Apache в том, что его проще настраивать. Для каких-то небольших корпоративных сайтов, мелких блогов и т.п. это вполне себе решение.
