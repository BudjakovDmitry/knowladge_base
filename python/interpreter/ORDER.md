# Порядок выполнения программ

Ниже описаны шаги, которые проделывает интерпретатор Python, чтобы выполнить исходный код программы. Все сказанное ниже справедливо для классическо реализации интерпретатора, но может отличаться для других реализаций.

В простейшей форме программа на Python представляет собой текстовый файл, содержащий операторы языка Python. По соглашению, файлы с программным кодом Python имеют расширение `.py`. Формально такая схема именования обязательна только для файлов, которые будут импортироваться, но для единообразия большинство файлов Python имеют расширение `.py`

Чтобы запустить программу, мы должны сообщить интерпретатору о необходмости *выполнить* файл. После этого интерпретатор будет выполнять все инструкции в файле от начала до конца друг за другом.

Итак, мы имеем исходный код на языке Python. Рассмотрим, что происходит "под капотом", когда мы запускаем эту программу.

## Компиляция в байт-код

Первым делом исходный код компилируется в *байт-код*. Байт-код - это низкоуровневое и платформонезависимое представление исходного кода. Грубо говоря, Python транслирует каждый оператор исходного кода в группу инструкций байт-кода, разбивая их на отдельные шаги. Байт-код способен выполнятся быстрее, чем первоначальные операторы исходного кода из текстового файла.

Если интерпретатор Python имеет доступ к записи на выполняемом компьютере, то он будет сохранять байт-код в файлах с расширением `.pyc` (.py compiled). В современных версиях языка эти файлы сохраняются в подкаталоге `__pycache__`, расположенном в каталоге с файлами исходного кода, а их имена идентифицируют версию языка, в которой они создавались. Например, `script.cpython-38.pyc`.

Если у интерпретатора нет прав на запись файлов на компьютере, то байт-код будет генерироваться в памяти и по завершению работы программы будет удаляться из памяти.

Байт-код сохраняется для оптимизации скорости выполнения программ. При последующих запусках программы, будут загружаться файлы с байт-кодом, тем самым будет пропущен этап компиляции. Правда перед этим интерпретатор убедиться, что файлы с исходным кодом не были изменены с момента последнего сохранения байт-кода и версия интерпретатора соответствует той, для которой был создан байт-код.

* Python автоматически проверит время последней модификации исходного кода и байт-кода. Если исходный код редактировался после того, как был сохранен байт-код, то при следующем запуске программы, байт-код будет автоматически создан заново.

* Версия интерпретатора проверяется по имени файла с байт-кодом. Для версий младше 3.2 номер версии интерпретатора содержится внутри файла с байт-кодом.

Поскольку файлы байт-кода ускоряют работу программ, то имеет смысл разрешить интерпретатору записывать их.

Файлы байт-кода можно использовать, как способ поставки программ. Они будут выполнятся даже если файлы с исходным кодом `.py` отсутствуют.

Стоит помнить, что файлы байт-кода сохраняются лишь для файлов, которые импортируются, но не для файлов верхнего уровня, которые запускаются как скрипты. Также байт-код не сохраняется для кода, набранного в интерактивном режиме.

## PVM

Скомпилированный байт-код отправляется виртуальной машине Python (Python Virtual Machine - PVM). PVM - это не отдельная программа и она не требует установки. По сути, PVM - это большой закодированный цикл, который проходит инструкции байт-кода одну за другой, чтобы выполнить их. PVM - это исполнительный механизм в Python. Она всегда присутствует в виде части системы Python и занимается тем, что по-настоящему выполняет то, что написано в сценарии. Формально, она является последним шагом того, что называется "интерпретатор Python".

## Что с производительностью?

Байт-код не является двоичным машинным кодом. Это представление, специфичное для Pyhon. С байт-кодом работает PVM, а не центральный процесор напрямую. PVM должна интерпретировать инструкции байт-кода, что требует большего времени, чем работа процессора напрямую с машинным кодом.
